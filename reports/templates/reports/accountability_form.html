{% extends "core/base.html" %}

{% block title %}{{ page_title }}{% endblock %}
{% block page_title %}{{ page_title }}{% endblock %}

{% block content %}
<div class="bg-white rounded-lg shadow-md p-6 mb-6">
    <form method="post" enctype="multipart/form-data">
        {% csrf_token %}
        
        <div class="space-y-4 mb-6">
            {% for field in form %}
                {% if not field.is_hidden %}
                    <div>
                        <label for="{{ field.id_for_label }}" class="block text-sm font-medium text-gray-700">{{ field.label }}</label>
                        {{ field }}
                        {% if field.help_text %}
                            <p class="mt-1 text-xs text-gray-500">{{ field.help_text }}</p>
                        {% endif %}
                        {% for error in field.errors %}
                            <p class="mt-1 text-xs text-red-600">{{ error }}</p>
                        {% endfor %}
                    </div>
                {% else %}
                    {{ field }}
                {% endif %}
            {% endfor %}
        </div>

        <h3 class="text-lg font-medium text-gray-900 mb-4 border-t pt-4">Documentos</h3>
        
        {{ document_formset.management_form }}
        <div id="document-formset" class="space-y-4">
            {% for doc_form in document_formset %}
                <div class="document-form border p-4 rounded-md bg-gray-50 relative">
                    {{ doc_form.id }}
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                        <div>
                            <label for="{{ doc_form.document.id_for_label }}" class="block text-sm font-medium text-gray-700">{{ doc_form.document.label }}</label>
                            {{ doc_form.document }}
                            {% for error in doc_form.document.errors %}
                                <p class="mt-1 text-xs text-red-600">{{ error }}</p>
                            {% endfor %}
                            {% if doc_form.instance.pk and doc_form.instance.document %}
                                <p class="mt-1 text-xs text-gray-500">Atual: <a href="{{ doc_form.instance.document.url }}" target="_blank" class="text-blue-600 hover:underline">{{ doc_form.instance.document.name|cut:"accountability_documents/" }}</a></p>
                            {% endif %}
                        </div>
                        <div>
                            <label for="{{ doc_form.description.id_for_label }}" class="block text-sm font-medium text-gray-700">{{ doc_form.description.label }}</label>
                            {{ doc_form.description }}
                            {% for error in doc_form.description.errors %}
                                <p class="mt-1 text-xs text-red-600">{{ error }}</p>
                            {% endfor %}
                        </div>
                    </div>
                    {% if document_formset.can_delete and doc_form.instance.pk %}
                        <div class="absolute top-2 right-2 flex items-center space-x-2">
                            <label for="{{ doc_form.DELETE.id_for_label }}" class="text-sm text-red-600">Excluir:</label>
                            {{ doc_form.DELETE }}
                        </div>
                    {% endif %}
                    {% for error in doc_form.non_field_errors %}
                        <p class="mt-2 text-xs text-red-600">{{ error }}</p>
                    {% endfor %}
                </div>
            {% endfor %}
        </div>
        
        <button type="button" id="add-document-form" class="mt-4 text-sm text-purple-600 hover:text-purple-800 font-medium">+ Adicionar outro documento</button>

        <div class="mt-6 flex justify-end space-x-3 border-t pt-4">
            <a href="{% url 'relatorios:accountability_list' %}" class="bg-gray-200 hover:bg-gray-300 text-gray-800 font-bold py-2 px-4 rounded">Cancelar</a>
            <button type="submit" class="bg-purple-600 hover:bg-purple-700 text-white font-bold py-2 px-4 rounded">{{ button_text }}</button>
        </div>
    </form>

    <!-- Template for new document forms (hidden) -->
    <div id="empty-form" class="hidden document-form border p-4 rounded-md bg-gray-50 relative">
        {{ document_formset.empty_form.id }}
        <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
            <div>
                <label for="{{ document_formset.empty_form.document.id_for_label }}" class="block text-sm font-medium text-gray-700">{{ document_formset.empty_form.document.label }}</label>
                {{ document_formset.empty_form.document }}
            </div>
            <div>
                <label for="{{ document_formset.empty_form.description.id_for_label }}" class="block text-sm font-medium text-gray-700">{{ document_formset.empty_form.description.label }}</label>
                {{ document_formset.empty_form.description }}
            </div>
        </div>
        {% if document_formset.can_delete %}
            <div class="absolute top-2 right-2 flex items-center space-x-2">
                <label for="{{ document_formset.empty_form.DELETE.id_for_label }}" class="text-sm text-red-600">Excluir:</label>
                {{ document_formset.empty_form.DELETE }}
            </div>
        {% endif %}
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
document.addEventListener('DOMContentLoaded', function() {
    const formsetContainer = document.getElementById('document-formset');
    const addButton = document.getElementById('add-document-form');
    const emptyFormTemplate = document.getElementById('empty-form').innerHTML;
    const totalFormsInput = document.querySelector('input[name="documents-TOTAL_FORMS"]');
    const formsetPrefix = 'documents'; // Make sure this matches the prefix in views.py
    let formCount = parseInt(totalFormsInput.value);

    addButton.addEventListener('click', function() {
        const newFormHtml = emptyFormTemplate.replace(/__prefix__/g, formCount);
        const newFormElement = document.createElement('div');
        newFormElement.innerHTML = newFormHtml;
        // Add classes to the new form element itself if needed
        newFormElement.firstElementChild.classList.add('document-form', 'border', 'p-4', 'rounded-md', 'bg-gray-50', 'relative', 'mt-4'); 
        formsetContainer.appendChild(newFormElement.firstElementChild);
        formCount++;
        totalFormsInput.value = formCount;
    });
});
</script>
{% endblock %}

